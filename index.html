<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Nuevo Presupuesto</title>
  <!-- Librería de Trello para Power-Ups -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- Nuestro script de inicialización del Power-Up (script.js) -->
  <script src="./script.js"></script>
  <style>
    /* Estilos Globales */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f0f0;
    }
    .container {
      background: #fff;
      max-width: 600px;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #FF9F1C;
    }
    /* Estilos para cada paso */
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    /* Inputs */
    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Sección de artículos */
    .search-bar {
      margin-bottom: 10px;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .article-item {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .article-item:hover {
      background: #f9f9f9;
    }
    .most-used {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f7f7f7;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .total-row {
      font-weight: bold;
    }
    /* Botones */
    .btn {
      background-color: #FF9F1C;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover {
      background-color: #e08d15;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Nuevo Presupuesto</h2>
    
    <!-- Paso 1: Datos del Cliente -->
    <div id="step1" class="step active">
      <h3>Datos del Cliente</h3>

      <!-- Seleccionar un cliente guardado -->
      <label for="savedClients">Clientes guardados:</label>
      <select id="savedClients">
        <option value="">-- Selecciona un cliente guardado --</option>
      </select>

      <label for="clientName">Nombre:</label>
      <input type="text" id="clientName" placeholder="Nombre del cliente">

      <label for="clientStreet">Calle:</label>
      <input type="text" id="clientStreet" placeholder="Calle">

      <label for="clientNumber">Número:</label>
      <input type="text" id="clientNumber" placeholder="Número de casa">

      <label for="clientPostalCode">Código Postal:</label>
      <input type="text" id="clientPostalCode" placeholder="Código Postal">

      <label for="clientCity">Ciudad:</label>
      <input type="text" id="clientCity" placeholder="Ciudad">

      <label for="clientPhone">Teléfono:</label>
      <input type="tel" id="clientPhone" placeholder="Teléfono">

      <label for="clientEmail">Email:</label>
      <input type="email" id="clientEmail" placeholder="Email">

      <!-- Recordar cliente -->
      <label>
        <input type="checkbox" id="rememberClient">
        Recordar cliente para futuras ocasiones
      </label>
    </div>
    
    <!-- Paso 2: Selección de Artículos -->
    <div id="step2" class="step">
      <h3>Selección de Artículos</h3>
      <input type="text" id="articleSearch" class="search-bar" placeholder="Buscar artículo...">
      <div id="articleList">
        <!-- Lista filtrable de artículos -->
      </div>

      <div class="most-used">
        <h4>Artículos más usados</h4>
        <div id="mostUsedArticles"></div>
      </div>

      <h4>Artículos Seleccionados</h4>
      <table id="selectedArticlesTable">
        <thead>
          <tr>
            <th>Artículo</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se agregarán filas aquí -->
        </tbody>
      </table>
      <p id="grandTotal">Total: $0.00</p>
    </div>
    
    <!-- Paso 3: Resumen y Generación -->
    <div id="step3" class="step">
      <h3>Resumen del Presupuesto</h3>
      <p><strong>Cliente:</strong> <span id="summaryClientName"></span></p>
      <p><strong>Calle / Número:</strong> <span id="summaryClientStreetNumber"></span></p>
      <p><strong>Código Postal / Ciudad:</strong> <span id="summaryClientPostalCity"></span></p>
      <p><strong>Teléfono:</strong> <span id="summaryClientPhone"></span></p>
      <p><strong>Email:</strong> <span id="summaryClientEmail"></span></p>

      <h4>Artículos:</h4>
      <div id="summaryArticles"></div>

      <p><strong>Total:</strong> $<span id="summaryTotal">0.00</span></p>
      <button id="generatePdfButton" class="btn">Generar Presupuesto (PDF)</button>
    </div>
    
    <div class="navigation-buttons">
      <button id="prevButton" class="btn" disabled>Anterior</button>
      <button id="nextButton" class="btn">Siguiente</button>
    </div>
  </div>

  <script>
    // Obtenemos la instancia del Power-Up
    const t = TrelloPowerUp.iframe();

    // Variables de navegación
    let currentStep = 1;
    const totalSteps = 3;
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');

    // Inputs del primer paso
    const savedClientsSelect = document.getElementById('savedClients');
    const clientNameInput = document.getElementById('clientName');
    const clientStreetInput = document.getElementById('clientStreet');
    const clientNumberInput = document.getElementById('clientNumber');
    const clientPostalCodeInput = document.getElementById('clientPostalCode');
    const clientCityInput = document.getElementById('clientCity');
    const clientPhoneInput = document.getElementById('clientPhone');
    const clientEmailInput = document.getElementById('clientEmail');
    const rememberClientCheckbox = document.getElementById('rememberClient');

    // Paso 2: Lista de productos y artículos más usados
    const products = [
      { id: 1, name: "Producto A", price: 10.00 },
      { id: 2, name: "Producto B", price: 20.00 },
      { id: 3, name: "Producto C", price: 15.50 },
      { id: 4, name: "Producto D", price: 5.75 },
      { id: 5, name: "Producto E", price: 12.30 }
    ];

    // Artículos más usados (ejemplo)
    const mostUsedProducts = [
      { id: 2, name: "Producto B", price: 20.00 },
      { id: 3, name: "Producto C", price: 15.50 }
    ];

    const articleSearchInput = document.getElementById('articleSearch');
    const articleListDiv = document.getElementById('articleList');
    const mostUsedArticlesDiv = document.getElementById('mostUsedArticles');
    const selectedArticlesTableBody = document.getElementById('selectedArticlesTable').querySelector('tbody');
    const grandTotalP = document.getElementById('grandTotal');
    let selectedArticles = []; // { id, name, price, quantity }

    // Paso 3: Resumen
    const summaryClientName = document.getElementById('summaryClientName');
    const summaryClientStreetNumber = document.getElementById('summaryClientStreetNumber');
    const summaryClientPostalCity = document.getElementById('summaryClientPostalCity');
    const summaryClientPhone = document.getElementById('summaryClientPhone');
    const summaryClientEmail = document.getElementById('summaryClientEmail');
    const summaryArticlesDiv = document.getElementById('summaryArticles');
    const summaryTotalSpan = document.getElementById('summaryTotal');

    // Funciones de navegación
    function showStep(step) {
      for (let i = 1; i <= totalSteps; i++) {
        document.getElementById('step' + i).classList.remove('active');
      }
      document.getElementById('step' + step).classList.add('active');
      prevButton.disabled = step === 1;
      nextButton.textContent = step === totalSteps ? 'Finalizar' : 'Siguiente';
    }

    prevButton.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    });

    nextButton.addEventListener('click', () => {
      if (currentStep < totalSteps) {
        currentStep++;
        if (currentStep === 3) {
          // Antes de mostrar el resumen, guardamos el cliente si está marcado "Recordar"
          if (rememberClientCheckbox.checked) {
            saveClientData();
          }
          populateSummary();
        }
        showStep(currentStep);
      } else {
        // Finalización
        alert('Presupuesto generado (simulado).');
        // Podrías cerrar el modal:
        // t.closeModal('Presupuesto generado');
      }
    });

    // ================== PASO 1: CLIENTES GUARDADOS ===================
    function loadSavedClients() {
      return t.get('member', 'private', 'savedClients').then(clients => {
        return clients || [];
      });
    }

    function saveClientData() {
      // Obtenemos la lista actual
      loadSavedClients().then(clients => {
        // Creamos un objeto con los datos del cliente
        const newClient = {
          name: clientNameInput.value.trim(),
          street: clientStreetInput.value.trim(),
          number: clientNumberInput.value.trim(),
          postalCode: clientPostalCodeInput.value.trim(),
          city: clientCityInput.value.trim(),
          phone: clientPhoneInput.value.trim(),
          email: clientEmailInput.value.trim()
        };
        // Evitamos duplicar si ya existe
        const exists = clients.find(c =>
          c.name === newClient.name &&
          c.street === newClient.street &&
          c.number === newClient.number &&
          c.postalCode === newClient.postalCode &&
          c.city === newClient.city &&
          c.phone === newClient.phone &&
          c.email === newClient.email
        );
        if (!exists) {
          clients.push(newClient);
          t.set('member', 'private', 'savedClients', clients);
        }
      });
    }

    function populateSavedClientsDropdown() {
      loadSavedClients().then(clients => {
        // Borramos opciones previas
        savedClientsSelect.innerHTML = '<option value="">-- Selecciona un cliente guardado --</option>';
        clients.forEach((client, index) => {
          const opt = document.createElement('option');
          opt.value = index;
          opt.textContent = client.name + " (" + client.city + ")";
          savedClientsSelect.appendChild(opt);
        });
      });
    }

    // Cuando el usuario elige un cliente guardado
    savedClientsSelect.addEventListener('change', (e) => {
      const idx = e.target.value;
      if (!idx) return;
      loadSavedClients().then(clients => {
        const c = clients[idx];
        clientNameInput.value = c.name;
        clientStreetInput.value = c.street;
        clientNumberInput.value = c.number;
        clientPostalCodeInput.value = c.postalCode;
        clientCityInput.value = c.city;
        clientPhoneInput.value = c.phone;
        clientEmailInput.value = c.email;
      });
    });

    // ================== PASO 2: ARTÍCULOS ===================
    function renderProductList(filter = '') {
      articleListDiv.innerHTML = '';
      const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
      filtered.forEach(product => {
        const div = document.createElement('div');
        div.className = 'article-item';
        div.textContent = `${product.name} ($${product.price.toFixed(2)})`;
        div.addEventListener('click', () => {
          // Si ya existe, no lo agregamos
          if (!selectedArticles.find(a => a.id === product.id)) {
            selectedArticles.push({ ...product, quantity: 1 });
            renderSelectedArticles();
          }
        });
        articleListDiv.appendChild(div);
      });
    }

    function renderSelectedArticles() {
      selectedArticlesTableBody.innerHTML = '';
      let total = 0;
      selectedArticles.forEach(article => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = article.name;
        const tdQuantity = document.createElement('td');
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.min = '1';
        qtyInput.value = article.quantity;
        qtyInput.style.width = '60px';
        qtyInput.addEventListener('change', (e) => {
          article.quantity = parseInt(e.target.value);
          renderSelectedArticles();
        });
        tdQuantity.appendChild(qtyInput);
        const tdUnitPrice = document.createElement('td');
        tdUnitPrice.textContent = "$" + article.price.toFixed(2);
        const tdTotal = document.createElement('td');
        const articleTotal = article.price * article.quantity;
        tdTotal.textContent = "$" + articleTotal.toFixed(2);
        total += articleTotal;
        tr.appendChild(tdName);
        tr.appendChild(tdQuantity);
        tr.appendChild(tdUnitPrice);
        tr.appendChild(tdTotal);
        selectedArticlesTableBody.appendChild(tr);
      });
      grandTotalP.textContent = "Total: $" + total.toFixed(2);
    }

    // Artículos más usados
    function renderMostUsedArticles() {
      mostUsedArticlesDiv.innerHTML = '';
      mostUsedProducts.forEach(product => {
        const div = document.createElement('div');
        div.className = 'article-item';
        div.textContent = `${product.name} ($${product.price.toFixed(2)})`;
        div.addEventListener('click', () => {
          if (!selectedArticles.find(a => a.id === product.id)) {
            selectedArticles.push({ ...product, quantity: 1 });
            renderSelectedArticles();
          }
        });
        mostUsedArticlesDiv.appendChild(div);
      });
    }

    // ================== PASO 3: RESUMEN ===================
    function populateSummary() {
      summaryClientName.textContent = clientNameInput.value;
      summaryClientStreetNumber.textContent = clientStreetInput.value + " / " + clientNumberInput.value;
      summaryClientPostalCity.textContent = clientPostalCodeInput.value + " / " + clientCityInput.value;
      summaryClientPhone.textContent = clientPhoneInput.value;
      summaryClientEmail.textContent = clientEmailInput.value;
      summaryArticlesDiv.innerHTML = '';
      let total = 0;
      selectedArticles.forEach(article => {
        const p = document.createElement('p');
        const lineTotal = article.price * article.quantity;
        p.textContent = `${article.name} x ${article.quantity} = $${lineTotal.toFixed(2)}`;
        summaryArticlesDiv.appendChild(p);
        total += lineTotal;
      });
      summaryTotalSpan.textContent = total.toFixed(2);
    }

    // (Opcional) Generar presupuesto en PDF
    document.getElementById('generatePdfButton').addEventListener('click', () => {
      alert('Generar PDF (simulado). Aquí podrías integrar jsPDF u otra librería.');
    });

    // Al cargar la página
    window.addEventListener('load', () => {
      // Cargamos la lista de clientes guardados
      populateSavedClientsDropdown();
      // Renderizamos la lista de artículos
      renderProductList();
      renderMostUsedArticles();
      showStep(currentStep);
    });

    // Buscador de artículos
    articleSearchInput.addEventListener('input', () => {
      renderProductList(articleSearchInput.value);
    });
  </script>
</body>
</html>
