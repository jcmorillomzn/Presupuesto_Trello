<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Nuevo Presupuesto</title>
  <!-- Librería de Trello para Power-Ups -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- Nuestro script con la inicialización del Power-Up -->
  <script src="./script.js"></script>
  <style>
    /* Estilos Globales */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f0f0;
    }
    .container {
      background: #fff;
      max-width: 600px;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #FF9F1C;
    }
    /* Estilos para cada paso */
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    /* Inputs */
    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    /* Estilos para la sección de artículos */
    .search-bar {
      margin-bottom: 10px;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .article-item {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .article-item:hover {
      background: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .total-row {
      font-weight: bold;
    }
    /* Botones */
    .btn {
      background-color: #FF9F1C;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover {
      background-color: #e08d15;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Nuevo Presupuesto</h2>
    
    <!-- Paso 1: Datos del Cliente -->
    <div id="step1" class="step active">
      <h3>Datos del Cliente</h3>
      <label for="clientName">Nombre:</label>
      <input type="text" id="clientName" placeholder="Nombre del cliente">
      <label for="clientAddress">Dirección:</label>
      <input type="text" id="clientAddress" placeholder="Dirección">
      <label for="clientPhone">Teléfono:</label>
      <input type="tel" id="clientPhone" placeholder="Teléfono">
      <label for="clientEmail">Email:</label>
      <input type="email" id="clientEmail" placeholder="Email">
    </div>
    
    <!-- Paso 2: Selección de Artículos -->
    <div id="step2" class="step">
      <h3>Selección de Artículos</h3>
      <input type="text" id="articleSearch" class="search-bar" placeholder="Buscar artículo...">
      <div id="articleList">
        <!-- Aquí se renderizarán los artículos -->
      </div>
      <h4>Artículos Seleccionados</h4>
      <table id="selectedArticlesTable">
        <thead>
          <tr>
            <th>Artículo</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se agregarán filas aquí -->
        </tbody>
      </table>
      <p id="grandTotal">Total: $0.00</p>
    </div>
    
    <!-- Paso 3: Resumen y Generación -->
    <div id="step3" class="step">
      <h3>Resumen del Presupuesto</h3>
      <p><strong>Cliente:</strong> <span id="summaryClientName"></span></p>
      <p><strong>Dirección:</strong> <span id="summaryClientAddress"></span></p>
      <p><strong>Teléfono:</strong> <span id="summaryClientPhone"></span></p>
      <p><strong>Email:</strong> <span id="summaryClientEmail"></span></p>
      <h4>Artículos:</h4>
      <div id="summaryArticles">
        <!-- Se mostrarán los artículos seleccionados -->
      </div>
      <p><strong>Total:</strong> $<span id="summaryTotal">0.00</span></p>
      <button id="generatePdfButton" class="btn">Generar Presupuesto (PDF)</button>
    </div>
    
    <div class="navigation-buttons">
      <button id="prevButton" class="btn" disabled>Anterior</button>
      <button id="nextButton" class="btn">Siguiente</button>
    </div>
  </div>

  <script>
    // Variables de navegación de pasos
    let currentStep = 1;
    const totalSteps = 3;
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');

    function showStep(step) {
      for (let i = 1; i <= totalSteps; i++) {
        document.getElementById('step' + i).classList.remove('active');
      }
      document.getElementById('step' + step).classList.add('active');
      prevButton.disabled = step === 1;
      nextButton.textContent = step === totalSteps ? 'Finalizar' : 'Siguiente';
    }

    prevButton.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    });

    nextButton.addEventListener('click', () => {
      if (currentStep < totalSteps) {
        currentStep++;
        if (currentStep === 3) {
          populateSummary();
        }
        showStep(currentStep);
      } else {
        // Finalización: aquí simulas la generación del presupuesto
        alert('Presupuesto generado (simulado).');
        // Podrías integrar jsPDF o enviar el HTML a una API para convertirlo en PDF.
        // Por ejemplo: TrelloPowerUp.iframe().closeModal('Presupuesto generado.');
      }
    });

    // Paso 2: Artículos
    // Simulamos una base de datos de productos
    const products = [
      { id: 1, name: "Producto A", price: 10.00 },
      { id: 2, name: "Producto B", price: 20.00 },
      { id: 3, name: "Producto C", price: 15.50 },
      { id: 4, name: "Producto D", price: 5.75 },
      { id: 5, name: "Producto E", price: 12.30 }
    ];

    const articleListDiv = document.getElementById('articleList');
    const selectedArticlesTableBody = document.getElementById('selectedArticlesTable').querySelector('tbody');
    const grandTotalP = document.getElementById('grandTotal');
    let selectedArticles = []; // Almacenamos { id, name, price, quantity }

    // Renderizamos la lista de productos
    function renderProductList(filter = '') {
      articleListDiv.innerHTML = '';
      const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
      filtered.forEach(product => {
        const div = document.createElement('div');
        div.className = 'article-item';
        div.textContent = product.name + " ($" + product.price.toFixed(2) + ")";
        div.addEventListener('click', () => {
          // Si el producto ya existe, no lo agregamos
          if (!selectedArticles.find(a => a.id === product.id)) {
            selectedArticles.push({ ...product, quantity: 1 });
            renderSelectedArticles();
          }
        });
        articleListDiv.appendChild(div);
      });
    }

    function renderSelectedArticles() {
      selectedArticlesTableBody.innerHTML = '';
      let total = 0;
      selectedArticles.forEach(article => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = article.name;
        const tdQuantity = document.createElement('td');
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.min = '1';
        qtyInput.value = article.quantity;
        qtyInput.style.width = '60px';
        qtyInput.addEventListener('change', (e) => {
          article.quantity = parseInt(e.target.value);
          renderSelectedArticles();
        });
        tdQuantity.appendChild(qtyInput);
        const tdUnitPrice = document.createElement('td');
        tdUnitPrice.textContent = "$" + article.price.toFixed(2);
        const tdTotal = document.createElement('td');
        const articleTotal = article.price * article.quantity;
        tdTotal.textContent = "$" + articleTotal.toFixed(2);
        total += articleTotal;
        tr.appendChild(tdName);
        tr.appendChild(tdQuantity);
        tr.appendChild(tdUnitPrice);
        tr.appendChild(tdTotal);
        selectedArticlesTableBody.appendChild(tr);
      });
      grandTotalP.textContent = "Total: $" + total.toFixed(2);
    }

    // Buscador de artículos
    const articleSearchInput = document.getElementById('articleSearch');
    articleSearchInput.addEventListener('input', () => {
      renderProductList(articleSearchInput.value);
    });
    renderProductList();

    // Paso 3: Resumen
    function populateSummary() {
      document.getElementById('summaryClientName').textContent = document.getElementById('clientName').value;
      document.getElementById('summaryClientAddress').textContent = document.getElementById('clientAddress').value;
      document.getElementById('summaryClientPhone').textContent = document.getElementById('clientPhone').value;
      document.getElementById('summaryClientEmail').textContent = document.getElementById('clientEmail').value;
      const summaryArticlesDiv = document.getElementById('summaryArticles');
      summaryArticlesDiv.innerHTML = '';
      let total = 0;
      selectedArticles.forEach(article => {
        const p = document.createElement('p');
        const lineTotal = article.price * article.quantity;
        p.textContent = `${article.name} x ${article.quantity} = $${lineTotal.toFixed(2)}`;
        summaryArticlesDiv.appendChild(p);
        total += lineTotal;
      });
      document.getElementById('summaryTotal').textContent = total.toFixed(2);
    }

    // (Opcional) Generar presupuesto en PDF
    document.getElementById('generatePdfButton').addEventListener('click', () => {
      alert('Generar PDF (simulado). Aquí podrías integrar jsPDF u otra librería.');
    });
  </script>
</body>
</html>
